name: Commit Stage
on: push
on: workflow_dispatch

env:
  BACKEND_DIR: ${{ github.workspace }}/services/agendo-backend/
  MVNW_PATH: ${{ github.workspace }}/services/agendo-backend/mvnw

jobs:
    build-and-test-backend:
        name: Build and test the backend
        runs-on: ubuntu-22.04
        permissions:
            contents: read
            security-events: write
        steps:
          - name: Checkout source code
            uses: actions/checkout@v4
          - name: Setup Java JDK
            uses: actions/setup-java@v4.6.0 
            with:
                distribution: temurin
                java-version: 21
                cache: maven
          - name: Code vulnerability scanning
            uses: anchore/scan-action@v6.0.0
            id: scan
            with:
                path: "${{ env.BACKEND_DIR }}"
                fail-build: true
                severity-cutoff: high
          - name: Upload vulnerability report
            uses: github/codeql-action/upload-sarif@v3
            if: success() || failure()
            with:
                sarif_file: ${{ steps.scan.outputs.sarif }}
          - name: Build, unit tests and integration tests
            run: |
                chmod +x ${{ env.MVNW_PATH }}
                ./${{ env.MVNW_PATH }} install